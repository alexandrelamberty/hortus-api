name: Build & Tests
on:
  push:
    branches:
      - "master"
      - "develop/**"
      - "releases/**"
      - "features/**"
  pull_request:
    branches: ["master", "stagging"]
  workflow_dispatch:
jobs:
  build:
    name: "Node build and tests"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Create build
        run: npm run build --if-present
        env:
          CI: ""

      - name: Run tests
        run: npm test
        env:
          NODE_ENV: "development"
          PORT: "3333"
          PAIRING_KEY: "9fca54477c8ad4e70dc5e1084f884aad"
          JWT_SECRET: "d7a481461577ba4c3c4c6946cca7204b"
          JWT_EXPIRE: "90"
          BCRYPT_HASH: "7f91317e30a02bc7b87205e95b842df2"
          DATABASE_URI: "mongodb://hortus:hortus@localhost:27017/hortus"
          STATIC_DIR: "/upload"
          UPLOAD_PATH: "/upload"
          CACHE_HOST: "localhost"
          CACHE_PORT: "6379"
          CACHE_TTL: "300"
          SESSION_HOST: "localhost"
          SESSION_PORT: "6380"
          SESSION_TTL: "300"
